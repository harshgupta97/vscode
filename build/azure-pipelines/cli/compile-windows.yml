parameters:
  - name: VSCODE_CLI_TARGETS
    default: []
    type: object
  - name: VSCODE_CLI_DIR
    type: string
    default: './'
  - name: VSCODE_CLI_BINARY_NAME
    type: string
  - name: channel
    type: string
    default: stable

steps:
  - template: ./install-rust.yml
    parameters:
      targets: ${{ parameters.VSCODE_CLI_TARGETS }}
      channel: ${{ parameters.channel }}

  - ${{ each target in parameters.VSCODE_CLI_TARGETS }}:
    - script: cargo build --release --target ${{ target.target }} --bin=${{ parameters.VSCODE_CLI_BINARY_NAME }}
      displayName: Compile ${{ target.artifact }}
      workingDirectory: ${{ parameters.VSCODE_CLI_DIR }}
      env:
        LAUNCHER_VERSION: $(LAUNCHER_VERSION)
        LAUNCHER_REMOTE_LICENSE_TEXT: $(LAUNCHER_REMOTE_LICENSE_TEXT)
        LAUNCHER_REMOTE_LICENSE_PROMPT: $(LAUNCHER_REMOTE_LICENSE_PROMPT)
        LAUNCHER_ASSET_NAME: ${{ target.artifact }}
        LAUNCHER_AI_KEY: $(VSCODE_CLI_AI_KEY)
        LAUNCHER_AI_ENDPOINT: $(VSCODE_CLI_AI_ENDPOINT)
        ${{ if eq(target, 'x86_64-pc-windows-msvc') }}:
          OPENSSL_LIB_DIR: $(Build.ArtifactStagingDirectory)/deps/x64-windows-static-md/lib
          OPENSSL_INCLUDE_DIR: $(Build.ArtifactStagingDirectory)/deps/x64-windows-static-md/include
        ${{ if eq(target, 'aarch64-pc-windows-msvc') }}:
          OPENSSL_LIB_DIR: $(Build.ArtifactStagingDirectory)/deps/arm64-windows-static-md/lib
          OPENSSL_INCLUDE_DIR: $(Build.ArtifactStagingDirectory)/deps/arm64-windows-static-md/include

    - publish: ${{ parameters.VSCODE_CLI_DIR }}/target/${{ target.target }}/release/${{ parameters.VSCODE_CLI_BINARY_NAME }}.exe
      artifact: ${{ target.artifact }}
      displayName: Publish ${{ target.artifact }} artifact
